<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gmail API OAuth Setup (Local)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .step {
        margin: 20px 0;
        padding: 15px;
        border-left: 4px solid #4285f4;
        background-color: #f8f9fa;
      }
      .code {
        background-color: #f1f3f4;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        word-break: break-all;
        margin: 10px 0;
      }
      button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 0;
      }
      button:hover {
        background-color: #3367d6;
      }
      .success {
        color: #137333;
        background-color: #e6f4ea;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
      }
      .error {
        color: #d93025;
        background-color: #fce8e6;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
      }
      input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        margin: 10px 0;
      }
      .copy-btn {
        background-color: #34a853;
        font-size: 12px;
        padding: 5px 10px;
        margin-left: 10px;
      }
      .warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Gmail API OAuth Setup (Local)</h1>

      <div class="warning">
        <strong>‚ö†Ô∏è Important:</strong> For this to work, you need to update the
        redirect URI in Google Cloud Console to:
        <code>https://artwithheartandgifts.com/oauth-callback.html</code>
      </div>

      <p>
        This tool will help you get the refresh token needed for Gmail API
        access.
      </p>

      <div class="step">
        <h3>Step 1: Generate Authorization URL</h3>
        <p>Click the button below to generate the authorization URL:</p>
        <button onclick="generateAuthUrl()">Generate Authorization URL</button>
        <div id="authUrlContainer" style="display: none">
          <p><strong>Copy this URL and open it in a new tab:</strong></p>
          <div class="code" id="authUrl"></div>
          <button class="copy-btn" onclick="copyToClipboard('authUrl')">
            Copy URL
          </button>
        </div>
      </div>

      <div class="step">
        <h3>Step 2: Get Authorization Code</h3>
        <p>After clicking the authorization URL above:</p>
        <ol>
          <li>
            Sign in with your Gmail account (artwithheartandgiftsllc@gmail.com)
          </li>
          <li>Grant the requested permissions</li>
          <li>You'll be redirected to your live site callback page</li>
          <li>Copy the authorization code from the callback page</li>
          <li>Paste it below:</li>
        </ol>
        <input
          type="text"
          id="authCode"
          placeholder="Paste authorization code here..."
        />
        <button onclick="exchangeCode()">Exchange Code for Tokens</button>
      </div>

      <div id="results" style="display: none">
        <div class="step">
          <h3>Step 3: Your Credentials</h3>
          <div id="credentials"></div>
        </div>
      </div>
    </div>

    <script>
      const CLIENT_ID =
        "329899517891-6gorclrla0t1dn54394b1577n1cdgkhm.apps.googleusercontent.com";
      const CLIENT_SECRET = "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";
      const REDIRECT_URI =
        "https://artwithheartandgifts.com/oauth-callback.html";

      const SCOPES = [
        "https://www.googleapis.com/auth/gmail.send",
        "https://www.googleapis.com/auth/gmail.compose",
      ];

      function generateAuthUrl() {
        const authUrl = new URL("https://accounts.google.com/o/oauth2/v2/auth");
        authUrl.searchParams.set("client_id", CLIENT_ID);
        authUrl.searchParams.set("redirect_uri", REDIRECT_URI);
        authUrl.searchParams.set("response_type", "code");
        authUrl.searchParams.set("scope", SCOPES.join(" "));
        authUrl.searchParams.set("access_type", "offline");
        authUrl.searchParams.set("prompt", "consent");

        document.getElementById("authUrl").textContent = authUrl.toString();
        document.getElementById("authUrlContainer").style.display = "block";
      }

      function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        navigator.clipboard.writeText(element.textContent).then(() => {
          alert("Copied to clipboard!");
        });
      }

      async function exchangeCode() {
        const authCode = document.getElementById("authCode").value.trim();
        if (!authCode) {
          alert("Please enter the authorization code first.");
          return;
        }

        try {
          const response = await fetch("https://oauth2.googleapis.com/token", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              code: authCode,
              client_id: CLIENT_ID,
              client_secret: CLIENT_SECRET,
              redirect_uri: REDIRECT_URI,
              grant_type: "authorization_code",
            }),
          });

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error_description || data.error);
          }

          // Display the credentials
          const credentialsHtml = `
                    <div class="success">
                        <h4>‚úÖ Success! Here are your credentials:</h4>
                        <p><strong>Refresh Token:</strong></p>
                        <div class="code">${data.refresh_token}</div>
                        <button class="copy-btn" onclick="copyToClipboard('refreshToken')">Copy</button>
                        
                        <p><strong>Access Token:</strong></p>
                        <div class="code">${data.access_token}</div>
                        <button class="copy-btn" onclick="copyToClipboard('accessToken')">Copy</button>
                        
                        <h4>üöÄ Add these to your Railway environment variables:</h4>
                        <div class="code">GOOGLE_CLIENT_ID=${CLIENT_ID}</div>
                        <button class="copy-btn" onclick="copyToClipboard('clientId')">Copy</button>
                        
                        <div class="code">GOOGLE_CLIENT_SECRET=${CLIENT_SECRET}</div>
                        <button class="copy-btn" onclick="copyToClipboard('clientSecret')">Copy</button>
                        
                        <div class="code">GOOGLE_REFRESH_TOKEN=${data.refresh_token}</div>
                        <button class="copy-btn" onclick="copyToClipboard('refreshTokenEnv')">Copy</button>
                    </div>
                `;

          document.getElementById("credentials").innerHTML = credentialsHtml;
          document.getElementById("results").style.display = "block";

          // Add hidden elements for copying
          const hiddenElements = `
                    <div id="refreshToken" style="display: none;">${data.refresh_token}</div>
                    <div id="accessToken" style="display: none;">${data.access_token}</div>
                    <div id="clientId" style="display: none;">GOOGLE_CLIENT_ID=${CLIENT_ID}</div>
                    <div id="clientSecret" style="display: none;">GOOGLE_CLIENT_SECRET=${CLIENT_SECRET}</div>
                    <div id="refreshTokenEnv" style="display: none;">GOOGLE_REFRESH_TOKEN=${data.refresh_token}</div>
                `;
          document.body.insertAdjacentHTML("beforeend", hiddenElements);

          // Test the token
          await testGmailAPI(data.access_token);
        } catch (error) {
          document.getElementById("credentials").innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error:</h4>
                        <p>${error.message}</p>
                    </div>
                `;
          document.getElementById("results").style.display = "block";
        }
      }

      async function testGmailAPI(accessToken) {
        try {
          const response = await fetch(
            "https://gmail.googleapis.com/gmail/v1/users/me/profile",
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          if (response.ok) {
            const profile = await response.json();
            document.getElementById("credentials").innerHTML += `
                        <div class="success">
                            <h4>üß™ Gmail API Test Successful!</h4>
                            <p>Email address: ${profile.emailAddress}</p>
                        </div>
                    `;
          } else {
            throw new Error("Gmail API test failed");
          }
        } catch (error) {
          console.error("Gmail API test failed:", error);
        }
      }
    </script>
  </body>
</html>
